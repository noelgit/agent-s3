# Agent-S3

Agent-S3 is a modern AI coding agent designed to empower engineers by emphasizing transparency, control, and strict adherence to guidelines. Recognizing that AI can and will make mistakes, Agent-S3 ensures that the engineer remains in control at every stage of the development process.

## Overview

Agent-S3 automates feature planning, code generation, and execution while maintaining a step-by-step approach to prioritize correctness over convenience. Key features include:

- **Structured Persona Debates:** During feature planning, Agent-S3 facilitates structured debates among predefined personas (e.g., Business, Expert Coder, Reviewer, Validator) to expose the Chain of Thought (CoT) of the LLM. This ensures that the generated plan is well-reasoned and adheres to strict guidelines.

- **Plan Approval Workflow:** Engineers can approve, reject, or modify the final step-by-step plan generated by the LLM. This ensures that every feature aligns with project requirements and guidelines.

- **Audit Trail Creation:** Each feature request is converted into a GitHub Issue, and subsequent changes are tracked through Pull Requests (PRs). This creates a transparent audit trail for all modifications.

- **Artifact Generation:** During code generation, Agent-S3 creates artifacts to monitor the LLM's steps and status. These artifacts provide visibility into the decision-making process and ensure accountability.

- **Multi-LLM Solution:** To prevent runaway costs, Agent-S3 implements a multi-LLM strategy. The chosen LLM is only as powerful as needed for the task, balancing cost and performance. This is supported by state-of-the-art context and cache management to optimize token usage and response times.

- **Step-by-Step Execution:** Agent-S3 intentionally follows a step-by-step approach to prioritize correctness. This involves multiple LLM calls, ensuring that each phase (planning, code generation, testing, etc.) is thoroughly validated before proceeding.

- **VS Code Extension:** For a consistent user experience, Agent-S3 integrates with Visual Studio Code as its primary user interface. The extension provides real-time feedback, progress tracking, and interactive prompts, ensuring seamless interaction between the engineer and the AI.

Agent-S3 is not just a tool for automation; it is a partner in development that prioritizes transparency, correctness, and engineer control at every step.

## Core Features

**Python Backend (`agent_s3`):**
- Real-time bidirectional communication between backend and VS Code extension via WebSocket server with:
  - Automatic reconnection and heartbeat monitoring
  - Message type-based routing and handlers
  - Fallback to file polling when WebSocket is unavailable
  - Authentication and secure message passing
- Advanced context management with:
  - Framework-specific context adaptation for popular frameworks (React, Django, Flask, FastAPI, Express)
  - Smart token allocation based on role, content type, and task requirements
  - Dynamic token budget allocation with priority-based and task-adaptive strategies
  - Context checkpoint system for state saving/recovery with version control compatibility
  - Context compression strategies (semantic summarization, key information extraction, reference-based) with comprehensive metadata for tracing and debugging
  - Dynamic file relevance scoring using hybrid search and Git modification history (frequency/recency)
  - Hierarchical summarization for large files
  - Semantic clustering for better context organization
- Comprehensive error handling and recovery:
  - Error pattern detection, caching, similarity matching, and pruning based on frequency/recency.
  - Type-specific error handlers for 12+ error categories (syntax, type, import, attribute, name, index, value, runtime, memory, permission, assertion, network, database).
  - Specialized context gathering based on error type (e.g., package info for imports, permissions for OS errors, network status).
  - Smart token budget allocation for error context.
  - Recovery suggestions based on error patterns and type.
  - Automated error recovery attempts for known patterns or common issues (e.g., installing missing packages via pip, fixing file permissions, running DB migrations).
- Design-to-Implementation Pipeline:
  - Conversational feature decomposition and architecture planning via `/design` command.
  - Industry best practice analysis and recommendations during design.
  - Automatic extraction and organization of single-concern features into hierarchical tasks.
  - Structured design document generation (`design.txt`).
  - Tracking implementation progress in `implementation_progress.json`.
  - Sequential implementation of tasks with the `/continue` command.
  - Automatic test execution after each implementation step.
- Persona-driven collaborative planning:
  - Multi-persona debate with distinct expert roles defined in `personas.md`.
  - Role-based perspective analysis and feedback.
  - Consensus-building through structured debate.
  - Business, technical, and quality assurance perspectives.
- CLI interface (`agent_s3.cli`) with commands: `/init`, `/help`, `/config`, `/reload-llm-config`, `/explain`, `/request`, `/cli`, `/design`, `/personas`, `/guidelines`, `/continue`. Supports multi-line heredoc input (`<<MARKER ... MARKER`) for `/cli file` and `/cli bash`.
- GitHub authentication via OAuth App and GitHub App flows (`agent_s3.auth`).
- Centralized configuration loading from `llm.json`, environment variables, and `.env` (`agent_s3.config`).
- Dynamic LLM routing by arbitrary roles defined in `llm.json`, with circuit breaker, fallback logic, and metrics tracking (`agent_s3.router_agent`).
- Resilient LLM calls with retry, exponential backoff, and fallback strategies (`agent_s3.llm_utils.call_llm_with_retry`).
- Persona-driven planning and debate among multiple roles (Business Dev, Expert Coder, Reviewer, Validator) in `agent_s3.planner` and `agent_s3.persona_debate`.
- Multi-phase task orchestration: planning, GitHub issue creation, code generation, execution/testing, and optional PR creation in `agent_s3.coordinator`.
- Iterative code generation & refinement (`agent_s3.code_generator`) with automated linting, testing, and diff-based user approvals.
- Retrieval-Augmented Generation (RAG) context: embedding-based search (`agent_s3.tools.embedding_client`) and hierarchical summarization (`agent_s3.tools.memory_manager`).
- Tech stack detection with versioning and best practice identification (`agent_s3.tools.tech_stack_manager`).
- Secure file operations (`FileTool`), sandboxed shell execution (`BashTool`, `TerminalExecutor`), and database interactions (`DatabaseTool`).
- Database Tool Features (`DatabaseTool`):
  - Query execution with SQLAlchemy (primary) and BashTool (fallback).
  - Parameterized queries (SQLAlchemy) and basic parameter substitution (BashTool).
  - Schema information retrieval (`get_schema_info`) using SQLAlchemy Inspector or fallback queries.
  - Query plan explanation (`explain_query`).
  - Database connection testing (`test_connection`).
  - SQL script execution (`execute_script`).
  - Explicit transaction control (`begin_transaction`, `commit_transaction`, `rollback_transaction`).
  - Security validation against dangerous commands and potential injection patterns.
  - Improved CLI output parsing for various DB types (CSV, TSV).
- Git operations and GitHub API integration (issues, PRs, repo metadata) via `agent_s3.tools.git_tool`.
- Code analysis, diff computation, and lint/test tooling via `agent_s3.tools.code_analysis_tool` and `agent_s3.tools.error_context_manager`.
- Comprehensive debugging system with Chain of Thought integration:
  - Three-tier debugging strategy (quick fix, full debugging, strategic restart)
  - Enhanced scratchpad with structured CoT logging (`agent_s3.enhanced_scratchpad_manager`)
  - Specialized error categorization and handling for 12+ error types (`agent_s3.debugging_manager`)
  - Context-aware error resolution with historical reasoning extraction
  - See [DEBUGGING.md](DEBUGGING.md) for details
- Comprehensive test coverage framework:
  - TestCritic for analyzing test quality and coverage (`agent_s3.tools.test_critic`)
  - TestFrameworks for framework-agnostic test generation (`agent_s3.tools.test_frameworks`)
  - TestPlanner for enforcing unit, integration, approval, and property-based tests (`agent_s3.test_planner`)
  - Feature decomposition and test requirement identification during pre-planning phase
- Progress tracking in `progress_log.json` (`agent_s3.progress_tracker`) and detailed chain-of-thought logs via enhanced scratchpad management (`agent_s3.enhanced_scratchpad_manager`).
- Interactive user prompts, plan reviews, patch diffs, and explanations via `agent_s3.prompt_moderator`.
- Workspace initialization (`/init`): Validates workspace (checks for `README.md`), creates default `.github/copilot-instructions.md`, `personas.md`, and `llm.json` if missing.
- Task State Management & Resumption (`TaskStateManager`):
  - Saves task state snapshots for each phase (Planning, PromptApproval, IssueCreation, CodeGeneration, Execution, PRCreation) to disk.
  - Allows resuming interrupted tasks from the last saved state via `/continue` or automatically on startup.
  - Supports granular resumption within Execution and PRCreation phases using sub-states (e.g., resuming after applying some changes but before running tests).
  - Tracks module scaffolding events in `development_status.json`.
- Advanced semantic caching for LLM calls:
  - TTL-based expiration, vector similarity search, and prefix-aware eviction
  - Atomic disk persistence under `.cache/semantic_cache/`
  - Metrics: hits, misses, semantic_hits (via `get_cache_stats()`)
  - Asynchronous cache storage to avoid blocking LLM calls
  - vLLM KV cache reuse for improved inference performance
  - Hybrid caching strategy combining semantic hits with tensor prefix reuse
  - Automatic tensor size tracking and hit counting for performance metrics

**VS Code Extension (`vscode`):**
- Command Palette integration: Initialize workspace, Make change request, Show help, Show config, Reload LLM config, Explain last LLM interaction, Open Chat Window.
- Status bar item (`$(sparkle) Agent-S3`) to start change requests.
- Dedicated terminal panel for backend interactions.
- Real-time progress monitoring by polling `progress_log.json`.
- Optional Copilot-style chat UI for input; terminal shows actual outputs.
- WebView panels for structured information display:
  - Persona debate discussions
  - Code change plan reviews
  - Diff visualization
  - Design documentation

## Prerequisites

- Python 3.10+ installed
- VS Code 1.60+ for extension features
- Git installed
- GitHub account and relevant tokens or app credentials

## Installation

1. **Python package:**
   ```bash
   pip install agent-s3
   ```
2. **VS Code Extension:**
   - Open the `vscode` folder in VS Code
   - Press `F5` to launch the extension in Extension Development Host, or
   - Build and install the `.vsix` via `vsce package`/`Extensions: Install from VSIX...`

## Configuration

- Create or adjust `llm.json` for model roles and endpoints.
- Set environment variables or include in a `.env`:
  - **GitHub OAuth:** `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`
  - **GitHub App:** `GITHUB_APP_ID`, `GITHUB_PRIVATE_KEY`
  - `GITHUB_ORG` (optional membership filter)
  - `OPENROUTER_KEY` (or other LLM keys)
  - `DENYLIST_COMMANDS`, `COMMAND_TIMEOUT`, `CLI_COMMAND_WARNINGS` in config

## Coding Guidelines

Agent-S3 can apply projectâ€‘specific coding instructions you provide in a `copilot-instructions.md` file at the repository root (under `.github/` by default). During code generation and analysis, the assistant:

- Loads and respects all instructions defined in this file.
- Applies your Core Development Criteria (security, performance, code quality, accessibility) and any additional guidelines you specify.
- Ignores or safely handles any instruction that would conflict with system safety policies or cause unsafe operations.

Place your coding rules, best practices, and user stories in `copilot-instructions.md` to guide Agent-S3's output.

## Usage

### CLI
```bash
# Initialize workspace (creates missing config files)
python -m agent_s3.cli /init

# Show help
python -m agent_s3.cli /help

# Show current config
python -m agent_s3.cli /config

# Reload LLM config from llm.json
python -m agent_s3.cli /reload-llm-config

# Explain last LLM interaction details
python -m agent_s3.cli /explain

# Generate plan only for a request
python -m agent_s3.cli /request "Your feature request"

# Start a design conversation
python -m agent_s3.cli /design "Design a scalable e-commerce system"

# Execute bash command bypassing LLM
python -m agent_s3.cli /cli bash "echo Hello"
# Simplified bash execution
python -m agent_s3.cli /cli "ls -la"

# Edit file bypassing LLM
python -m agent_s3.cli /cli file path/to/file.txt "new content"

# Multi-line bash command with heredoc syntax
python -m agent_s3.cli /cli bash <<EOT
echo "Line 1"
echo "Line 2"
EOT

# Multi-line file content with heredoc syntax
python -m agent_s3.cli /cli file path/to/script.sh <<EOF
#!/bin/bash
echo "Hello from script"
EOF

# Create default personas.md
python -m agent_s3.cli /personas

# Create default copilot-instructions.md
python -m agent_s3.cli /guidelines

# Attempt to resume the last interrupted task
python -m agent_s3.cli /continue

# Process a full change request (plan, generate, execute)
python -m agent_s3.cli "Implement user authentication using JWT"
``` 

### VS Code
- **Initialize:** `Agent-S3: Initialize workspace`
- **Make change:** `Agent-S3: Make change request` or click status bar
- **Show help, config, reload, explain:** corresponding commands in palette
- **Chat UI:** `Agent-S3: Open Chat Window` (input only; follow terminal prompts)

## Development

- **Tests:** `pytest`
- **Type Checking:** `mypy agent_s3`
- **Linting:** `ruff check agent_s3`

## Contributing

Contributions welcome! Please:
- Ensure tests pass and lint/type checks are clean
- Follow PEP 8 and core criteria in `.github/copilot-instructions.md`
- Use conventional commits

## License

MIT License. See `LICENSE` or `pyproject.toml` for details.